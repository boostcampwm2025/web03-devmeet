name: Gitopsì— ë§Œë“¤ image build + gitops pr ìƒì„±

on: 
  pull_request:
    # prì´ ë‹«í˜”ì„ë•Œë§Œ ì‘ë™ ( mergeë“  ì—¬ëŸ¬ê°€ì§€ ì´ìœ ë¡œ ë‹«í ìˆ˜ ìˆìŒ )
    types: [closed]
    branches: [main]

concurrency:
  group: main
  cancel-in-progress: true

jobs:
  main-guards:
    # pull_requestì´ ì˜¤ì§ mergeë¡œ ë‹«íˆëŠ” ê²½ìš°ì—ë§Œ + devê°€ head ë¸ŒëŸ°ì¹˜ ë§ìœ¼ë©´ ì„±ê³µ
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.ref == 'dev'
    runs-on: ubuntu-22.04
    # ì´ jobì—ì„œ ê³„ì‚°í•œ ê°’ì„ ë‹¤ë¥¸ jobì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì •í•¨
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: "dev -> main merge í™•ì¸"
        run: echo "dev -> main merged. run build + gitops PR."    

      - name: Build tag from merge commit sha
        id: meta
        shell: bash
        run: |
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          TAG="sha-${MERGE_SHA:0:7}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG" >> "$GITHUB_ENV"
          echo "MERGE_SHA=$MERGE_SHA" >> "$GITHUB_ENV"
          echo "MERGE_SHA=$MERGE_SHA ì‚¬ìš©"
          echo "TAG=$TAG ì‚¬ìš©"

  # ë°°í¬ìš© íŒŒì¼ ë¹Œë“œ í›„ ë°°í¬
  main-backend-build:
    needs: [main-guards]
    name: Docker main ë°±ì—”ë“œ ë¹Œë“œ
    runs-on: ubuntu-22.04
    # í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ… ( main-guardsì—ì„œ ì§€ì •í•œ tagë¥¼ ì§€ì •í•¨ )
    env: 
      TAG: ${{ needs.main-guards.outputs.tag }}
    steps:
      - name: Checkout Docker backend
        uses: actions/checkout@v5

      - name: QEMU ì„¤ì •
        uses: docker/setup-qemu-action@v3

      - name: Buildidx ì„¸íŒ…
        uses: docker/setup-buildx-action@v3

      - name: Dockerhub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: BuildIdxë¥¼ ì´ìš©í•´ì„œ build í›„ cacheí•˜ê¸° 
        uses: docker/build-push-action@v5
        with: 
          context: ./rep/main_backend
          file: ./rep/main_backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_MAIN_BACKEND_DEPLOY_SERVER_IMG }}:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_MAIN_BACKEND_DEPLOY_SERVER_IMG }}:${{env.TAG}}
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_MAIN_BACKEND_DEPLOY_SERVER_IMG }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_MAIN_BACKEND_DEPLOY_SERVER_IMG }}:buildcache,mode=max
  
  tool-backend-build:
    needs: [main-guards]
    name: Docker tool ë°±ì—”ë“œ ë¹Œë“œ
    runs-on: ubuntu-22.04
    env:
      TAG: ${{ needs.main-guards.outputs.tag }}
    steps:
      - name: Checkout Docker backend
        uses: actions/checkout@v5

      - name: QEMU ì„¤ì •
        uses: docker/setup-qemu-action@v3

      - name: Buildidx ì„¸íŒ…
        uses: docker/setup-buildx-action@v3

      - name: Dockerhub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      
      - name: Docker ë¹Œë“œ í›„ push (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ./rep/tool_backend
          file: ./rep/tool_backend/Dockerfile
          push: true
          # amd64ë¥¼ ì‚¬ìš©í•´ì„œ ìœ„ì— ì¡°ì‚¬ë¥¼ ìŠ¤í‚µí•  ì˜ˆì •ì´ë‹¤.
          platforms: linux/amd64

          # docker image ê´€ë¦¬
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_TOOL_BACKEND_DEPLOY_SERVER_IMG }}:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_TOOL_BACKEND_DEPLOY_SERVER_IMG }}:${{env.TAG}}

          # caching ì‘ì—… - ëª¨ë“  ë¹Œë“œë‹¨ê³„ ë ˆì´ì–´ ìºì‹± ì¦‰ maxë¥¼ ì„¤ì •í•´ì„œ ìš©ëŸ‰ì€ ë§ì´ ì“°ì§€ë§Œ ì„±ëŠ¥ì€ ë†’ì¸ë‹¤. 
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_TOOL_BACKEND_DEPLOY_SERVER_IMG }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_TOOL_BACKEND_DEPLOY_SERVER_IMG }}:buildcache,mode=max      


  frontend-build:
    needs: [main-guards]
    name: Docker í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
    runs-on: ubuntu-22.04
    env:
      TAG: ${{ needs.main-guards.outputs.tag }}
    steps:
      - name: Checkout Docker frontend
        uses: actions/checkout@v5

      - name: frontend env ìƒì„±
        run: | 
          cat << 'EOF' > ./frontend/.env.frontend
          ${{ secrets.NODE_FRONTEND_ENV_DEPLOY_SERVER }}
          EOF

      - name: QEMU ì„¤ì •
        uses: docker/setup-qemu-action@v3

      - name: Buildidx ì„¸íŒ…
        uses: docker/setup-buildx-action@v3

      - name: Dockerhub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: BuildIdxë¥¼ ì´ìš©í•´ì„œ build í›„ cacheí•˜ê¸° 
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_FRONTEND_DEPLOY_SERVER_IMG }}:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_FRONTEND_DEPLOY_SERVER_IMG }}:${{env.TAG}}
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_FRONTEND_DEPLOY_SERVER_IMG }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_FRONTEND_DEPLOY_SERVER_IMG }}:buildcache,mode=max
  
  # argo cdê°€ ê°ì§€í•˜ê²Œ í•˜ëŠ” gitops ë°°í¬ ë°©ì‹
  deploy: 
    name: GitOps - docker hub ì´ë¯¸ì§€ customize 
    runs-on: ubuntu-22.04
    needs:
      - main-guards
      - main-backend-build
      - tool-backend-build
      - frontend-build
    env:
      TAG: ${{ needs.main-guards.outputs.tag }}

    permissions:
      # ê°™ì€ ë ˆí¬ì— í‘¸ì‹œ í•˜ê¸° ìœ„í•´ ë’¤ì— sha íƒœê·¸ ë³€ê²½ì„ pushí•´ì•¼ í•˜ëŠ”ë° ê·¸ë•Œ ê¶Œí•œì„ ì´ê±¸ë¡œ ì¤€ë‹¤. 
      contents: write 
      pull-requests: write  

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          ref: main

      # yamlì„ í¸ì§‘í•˜ê¸° ìœ„í•œ ë„êµ¬
      - name: yq ì„¤ì¹˜
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: kustomization.yamlì— ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ í•˜ê¸°
        env:
          SHA: ${{ github.sha }}
        run: |
          FILE="deploy/https/curr/kustomization.yaml"

          # kustomization.yaml ì¡´ì¬ë¥¼ ì²´í¬í•œë‹¤.
          test -f "$FILE"

          # newTagë¥¼ ë³€í™˜
          TAG="sha-${SHA:0:7}"

          # kustomize.yamlì— newTagë¥¼ ê·¸ëŒ€ë¡œ ë°”ê¾¼ë‹¤. 
          yq -i '
            (.images[] | select(.name=="docker.io/logankimdoing/frontend-deploy-server-img").newTag) = strenv(TAG) |
            (.images[] | select(.name=="docker.io/logankimdoing/main-backend-deploy-server-img").newTag) = strenv(TAG) |
            (.images[] | select(.name=="docker.io/logankimdoing/tool-backend-deploy-server-img").newTag) = strenv(TAG)
          ' "$FILE"

          echo "tag ì—…ë°ì´íŠ¸: $TAG"
          # ë³€í•œ íŒŒì¼ 
          cat "$FILE"
      
      # Argo cdê°€ í™•ì¸í•  ìˆ˜ ìˆê²Œ íƒœê·¸ê°€ ë³€ê²½ëœ yamlì— ëŒ€í•œ prì„ ì˜¬ë¦¼ ( prì— prì€ ìŠ¤íŒ )
      - name: pr ìƒì„± (GitOps)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(gitops): kustomization image íƒœê·¸ ì—…ë°ì´íŠ¸ sha-${{ env.TAG }} [skip gitops]"
          title: "ğŸšš chore(gitops): ê¹ƒí—ˆë¸Œ kustomizationì— ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½ sha-${{ env.TAG }}"
          body: "Kustomization ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë³€ê²½í•´ì„œ argo cdê°€ ì¸ì‹í•˜ë„ë¡ í•œë‹¤."
          branch: "gitops/bump-images-${{ env.TAG }}"
          base: main
          add-paths: |
            deploy/https/curr/kustomization.yaml
          labels: |
            gitops